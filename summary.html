<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Summary</title>

  <!-- Firebase (compat) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="js/firebase-config.js"></script>

  <!-- Calendar logic (pure JS file you’re serving at this path) -->
  <script defer src="js/calendar-render.js"></script>

  <style>
    :root{
      --bg:#fffafc; --ink:#222; --muted:#6b6b6b; --card:#ffffff;
      --red:#f28b82; --green:#a5d6a7; --blue:#8ab4f8; --amber:#fbc02d; --purple:#d15fa7;
      --grid:#e9e9e9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"Segoe UI",system-ui,-apple-system,sans-serif}
    header{position:sticky;top:0;background:var(--bg);z-index:10;padding:12px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0;font-weight:600}
    header .spacer{flex:1}
    button{border:none;background:#88a58d;color:#fff;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}

    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .calendar{background:var(--card);border:1px solid #eee;border-radius:12px;padding:12px}
    .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cal-title{font-weight:700}
    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      border-top:1px solid var(--grid);
      padding-top:8px;
    }
    .dow{font-size:12px;color:var(--muted);text-align:center}
    .day{
      min-height:72px;
      border:1px solid var(--grid);
      border-radius:10px;
      padding:6px;
      position:relative;
      background:#fff;
      overflow:hidden;
    }
    .day .num{font-size:12px;color:var(--muted)}
    /* Marks */
    .day.period{background: rgba(242,139,130,0.25)}
    .day.fertile{background: rgba(251,192,45,0.22)}
    .day.luteal{background: rgba(165,214,167,0.22)}
    .day.surge::after{
      content:"";
      position:absolute; right:6px; top:6px;
      width:8px; height:8px; border-radius:50%; background:var(--purple);
    }
    .day.ovulation::after{
      content:"";
      position:absolute; right:6px; top:6px;
      width:8px; height:8px; border-radius:50%; background:var(--blue);
    }
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;font-size:12px;color:var(--muted)}
    .sw{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px;vertical-align:middle}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .card{background:var(--card);border:1px solid #eee;border-radius:12px;padding:10px;flex:1;min-width:220px}
    .card h3{font-size:14px;margin:0 0 4px;color:var(--muted)}
    .card .value{font-size:22px;font-weight:700}
    .foot{color:var(--muted);font-size:12px;margin-top:4px}
  </style>
</head>
<body>
  <header>
    <h1>Cycle Summary</h1>
    <div class="spacer"></div>
    <button id="prevBtn" aria-label="Previous month">◀</button>
    <button id="todayBtn" aria-label="Jump to current month">Today</button>
    <button id="nextBtn" aria-label="Next month">▶</button>
  </header>

  <div class="wrap">
    <section class="calendar">
      <div class="cal-header">
        <div class="cal-title" id="calTitle">…</div>
      </div>
      <div class="cal-grid" id="calGrid">
        <!-- DOW header -->
      </div>

      <div class="legend">
        <span><span class="sw" style="background:var(--red)"></span>Period</span>
        <span><span class="sw" style="background:var(--amber)"></span>Fertile</span>
        <span><span class="sw" style="background:var(--purple)"></span>Surge (dot)</span>
        <span><span class="sw" style="background:var(--blue)"></span>Ovulation (dot)</span>
        <span><span class="sw" style="background:var(--green)"></span>Luteal</span>
      </div>
    </section>

    <div class="row">
      <div class="card">
        <h3>Status</h3>
        <div class="value" id="statusVal">—</div>
        <div class="foot" id="statusFoot">Waiting…</div>
      </div>
      <div class="card">
        <h3>Last log</h3>
        <div class="value" id="lastLogVal">—</div>
        <div class="foot" id="lastLogFoot">—</div>
      </div>
      <div class="card">
        <h3>Notes</h3>
        <div class="value" style="font-size:14px" id="notesVal">Surge ≥ 1.0 or “Surge/Solid”. Ovulation = surge + 1 day. Live cycle supported.</div>
      </div>
    </div>
  </div>

  <!-- Inline boot script (runs after calendar-render.js because of defer) -->
  <script defer>
    // ====== Month grid builder ======
    const calTitle = document.getElementById('calTitle');
    const calGrid  = document.getElementById('calGrid');

    const DOW = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

    // Track which month is showing
    let viewYear, viewMonth; // month = 0..11

    function firstOfMonth(y, m){ return new Date(Date.UTC(y, m, 1)); }
    function lastOfMonth(y, m){ return new Date(Date.UTC(y, m+1, 0)); }
    function pad2(n){ return n<10 ? '0'+n : ''+n; }
    function iso(d){ return d.toISOString().slice(0,10); }

    function renderCalendar(y, m){
      viewYear = y; viewMonth = m;

      calTitle.textContent = new Date(Date.UTC(y,m,1)).toLocaleString('en-GB', { month:'long', year:'numeric', timeZone:'UTC' });

      // Build headers (DOW)
      calGrid.innerHTML = '';
      for(const dn of DOW){
        const h = document.createElement('div');
        h.className = 'dow';
        h.textContent = dn;
        calGrid.appendChild(h);
      }

      // Determine how many leading blanks (Mon=0 … Sun=6)
      const first = firstOfMonth(y,m);
      let dow = (first.getUTCDay()+6)%7; // convert Sun(0)→6
      const daysInMonth = lastOfMonth(y,m).getUTCDate();

      // Leading blanks
      for(let i=0;i<dow;i++){
        const d = document.createElement('div');
        d.className = 'day';
        d.setAttribute('data-date','');
        d.style.visibility='hidden';
        calGrid.appendChild(d);
      }

      // Month days
      for(let day=1; day<=daysInMonth; day++){
        const date = `${y}-${pad2(m+1)}-${pad2(day)}`;
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.setAttribute('data-date', date);
        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = String(day);
        cell.appendChild(num);
        calGrid.appendChild(cell);
      }

      // Trailing fill to complete 6 weeks view (optional; fine to omit)
      const totalCells = 7 + dow + daysInMonth; // 7 DOW + leading + days
      const rows = Math.ceil(totalCells/7);
      const need = rows*7 - totalCells;
      for(let i=0;i<need;i++){
        const d = document.createElement('div');
        d.className = 'day';
        d.setAttribute('data-date','');
        d.style.visibility='hidden';
        calGrid.appendChild(d);
      }
    }

    function jumpToToday(){
      const now = new Date();
      renderCalendar(now.getUTCFullYear(), now.getUTCMonth());
    }

    // ====== Compat shim: map changeCycle(...) -> initializeCycleView(...) ======
    window.changeCycle = window.changeCycle || (async function(idx){
      if (typeof window.initializeCycleView !== 'function') {
        throw new Error('initializeCycleView missing (calendar-render.js not loaded?)');
      }
      // Re-mark current grid
      return window.initializeCycleView({
        container: document,
        onComputed: (cycles) => {
          // Update status cards quickly
          const last = cycles[cycles.length-1];
          const statusVal = document.getElementById('statusVal');
          const statusFoot = document.getElementById('statusFoot');
          const lastLogVal = document.getElementById('lastLogVal');
          const lastLogFoot = document.getElementById('lastLogFoot');

          if (last && !last.completed) {
            if (last.ovulationDate)      statusVal.textContent = `Ovulation: ${last.ovulationDate.toISOString().slice(0,10)}`;
            else if (last.surgeDate)     statusVal.textContent = `Surge: ${last.surgeDate.toISOString().slice(0,10)}`;
            else                         statusVal.textContent = `Live cycle`;
            statusFoot.textContent = `Start: ${last.startDate.toISOString().slice(0,10)}`;
          } else if (last) {
            statusVal.textContent = `Completed cycle`;
            statusFoot.textContent = `Start: ${last.startDate.toISOString().slice(0,10)}`;
          } else {
            statusVal.textContent = '—';
            statusFoot.textContent = 'No cycles';
          }

          // Last log
          const allDates = [];
          for (const c of cycles) for (const e of c.entries) if (e._date) allDates.push(e._date);
          allDates.sort((a,b)=>a-b);
          const lastDate = allDates[allDates.length-1];
          lastLogVal.textContent = lastDate ? lastDate.toISOString().slice(0,10) : '—';
          lastLogFoot.textContent = `${cycles.length} cycle(s)`;
        }
      });
    });

    // ====== Wiring & run() ======
    document.getElementById('prevBtn').addEventListener('click', async ()=>{
      const d = new Date(Date.UTC(viewYear, viewMonth, 1));
      d.setUTCMonth(viewMonth - 1);
      renderCalendar(d.getUTCFullYear(), d.getUTCMonth());
      await window.changeCycle(0);
    });
    document.getElementById('todayBtn').addEventListener('click', async ()=>{
      jumpToToday();
      await window.changeCycle(0);
    });
    document.getElementById('nextBtn').addEventListener('click', async ()=>{
      const d = new Date(Date.UTC(viewYear, viewMonth, 1));
      d.setUTCMonth(viewMonth + 1);
      renderCalendar(d.getUTCFullYear(), d.getUTCMonth());
      await window.changeCycle(0);
    });

    async function run(){
      console.log('run() started');

      // Wait for auth (so calendar-render.js can read Firestore when it runs)
      const user = await new Promise(res=>{
        const off = firebase.auth().onAuthStateChanged(u=>{ off(); res(u); });
      });
      if (!user) {
        console.warn('No user; redirecting to login');
        window.location.href = 'index.html';
        return;
      }
      console.log('User logged in:', user.uid);

      // Build current month grid first (so markers have DOM to target)
      jumpToToday();

      // Preload entries just to mirror your existing logs (calendar-render.js will also fetch)
      // This is optional; if you want to skip double-load, remove this block.
      let entriesLoaded = 0;
      try{
        const db = firebase.firestore();
        const norm = d => {
          const o = d.data(); const id = d.id;
          const v = o.timestamp || o.timeStamp || o.ts || o.recordedAt || o.date || o.Date || o.createdAt || o.created || o.created_on || o.id;
          const dt = v ? new Date(String(v)) : null;
          return dt && !isNaN(dt) ? { _date: dt, id } : null;
        };
        const [A,B] = await Promise.all([
          db.collection('entries').get().then(s=>s.docs.map(norm).filter(Boolean)).catch(()=>[]),
          db.collection('users').doc(user.uid).collection('entries').get().then(s=>s.docs.map(norm).filter(Boolean)).catch(()=>[])
        ]);
        entriesLoaded = A.length + B.length;
      }catch(_){}
      console.log('Entries loaded:', entriesLoaded);

      // Compute cycles once via initializeCycleView (it returns cycles)
      const cycles = await window.initializeCycleView({
        container: document,
        onComputed: (cs)=>{} // no-op; we log below
      });
      console.log('Built allCycles:', cycles.length);

      console.log('Rendering initial cycle data');
      await window.changeCycle(0); // compat path used by your legacy code

      console.log('Summary ready.');
    }

    document.addEventListener('DOMContentLoaded', run);
  </script>
</body>
</html>
